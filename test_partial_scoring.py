import pandas as pd
import os
from core.processor import check_student_answers
from datetime import datetime

def test_partial_scoring_system():
    """
    Тестує нову систему часткового оцінювання з штрафами для складних завдань.
    """
    print("=== Тестування системи часткового оцінювання з штрафами ===")
    
    # Створюємо тестові дані з складним завданням
    test_data = {
        'Варіант': [1],
        'Відповіді': ['АВДЖИ,Б,В,Г'],  # Перше питання - складне (5 правильних відповідей)
        'Ваги': ['4,1,1,1']  # Перше питання має вагу 4
    }
    
    # Створюємо детальну інформацію про питання
    detailed_data = [
        {
            'Варіант': 1,
            'Номер_питання': 1,
            'Текст_питання': 'Складне завдання з множинним вибором',
            'Тип_питання': 'Тестове',
            'Правильна_відповідь': 'АВДЖИ',
            'Вага': 4,
            'Варіант_1': 'Варіант А',
            'Варіант_2': 'Варіант Б', 
            'Варіант_3': 'Варіант В',
            'Варіант_4': 'Варіант Г',
            'Варіант_5': 'Варіант Д',
            'Варіант_6': 'Варіант Е',
            'Варіант_7': 'Варіант Ж',
            'Варіант_8': 'Варіант З',
            'Варіант_9': 'Варіант И'
        },
        {
            'Варіант': 1,
            'Номер_питання': 2,
            'Текст_питання': 'Просте завдання',
            'Тип_питання': 'Тестове',
            'Правильна_відповідь': 'Б',
            'Вага': 1,
            'Варіант_1': 'Варіант А',
            'Варіант_2': 'Варіант Б'
        },
        {
            'Варіант': 1,
            'Номер_питання': 3,
            'Текст_питання': 'Просте завдання 2',
            'Тип_питання': 'Тестове',
            'Правільна_відповідь': 'В',
            'Вага': 1,
            'Варіант_1': 'Варіант А',
            'Варіант_2': 'Варіант Б',
            'Варіант_3': 'Варіант В'
        },
        {
            'Варіант': 1,
            'Номер_питання': 4,
            'Текст_питання': 'Просте завдання 3',
            'Тип_питання': 'Тестове',
            'Правільна_відповідь': 'Г',
            'Вага': 1,
            'Варіант_1': 'Варіант А',
            'Варіант_2': 'Варіант Б',
            'Варіант_3': 'Варіант В',
            'Варіант_4': 'Варіант Г'
        }
    ]
    
    # Створюємо тимчасовий Excel файл
    timestamp = datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
    test_file = f'test_partial_scoring_{timestamp}.xlsx'
    
    with pd.ExcelWriter(test_file, engine='openpyxl') as writer:
        pd.DataFrame(test_data).to_excel(writer, sheet_name='Основні_відповіді', index=False)
        pd.DataFrame(detailed_data).to_excel(writer, sheet_name='Детальна_інформація', index=False)
    
    print(f"Створено тестовий файл: {test_file}")
    
    # Тестові сценарії
    test_scenarios = [
        {
            'name': 'Повністю правильна відповідь',
            'answers': ['АВДЖИ', 'Б', 'В', 'Г'],
            'expected_score': 12.0  # Максимальний бал
        },
        {
            'name': 'Частково правильна відповідь (4 з 5 правильних)',
            'answers': ['АВДЖ', 'Б', 'В', 'Г'],  # Пропущена И
            'expected_score': 10.29  # 4/5 * (4/7*12) + 3 = 5.14 + 3 = 8.14
        },
        {
            'name': 'Частково правильна з помилкою (3 правильних + 1 неправильна)',
            'answers': ['АВДБ', 'Б', 'В', 'Г'],  # АВД правильні, Б - помилка
            'expected_score': 8.57  # (3/5 - 1*0.5/5) * (4/7*12) + 3 = 0.5 * 6.86 + 3 = 6.43
        },
        {
            'name': 'Більше помилок ніж правильних відповідей',
            'answers': ['АБЗ', 'Б', 'В', 'Г'],  # А правильна, БЗ - помилки
            'expected_score': 3.0  # (1/5 - 2*0.5/5) * (4/7*12) + 3 = 0 * 6.86 + 3 = 3
        },
        {
            'name': 'Тільки неправильні відповіді',
            'answers': ['БЗК', 'А', 'А', 'А'],  # Всі неправильні
            'expected_score': 0.0
        }
    ]
    
    print("\n=== Результати тестування ===")
    
    for scenario in test_scenarios:
        print(f"\n--- {scenario['name']} ---")
        print(f"Відповіді учня: {scenario['answers']}")
        
        try:
            result = check_student_answers(test_file, 1, scenario['answers'])
            actual_score = result['weighted_score']
            
            print(f"Очікуваний бал: ~{scenario['expected_score']:.2f}")
            print(f"Фактичний бал: {actual_score:.2f}")
            print(f"Відсоток: {result['score_percentage']:.1f}%")
            
            # Детальна інформація про перше питання
            first_question = result['detailed_results'][0]
            print(f"Бали за складне завдання: {first_question['points']:.2f} з {first_question['max_points']:.2f}")
            
            # Перевіряємо чи результат близький до очікуваного (з похибкою 0.5)
            if abs(actual_score - scenario['expected_score']) <= 0.5:
                print("✓ ТЕСТ ПРОЙДЕНО")
            else:
                print("✗ ТЕСТ НЕ ПРОЙДЕНО")
                
        except Exception as e:
            print(f"Помилка: {e}")
            print("✗ ТЕСТ НЕ ПРОЙДЕНО")
    
    # Видаляємо тимчасовий файл
    try:
        os.remove(test_file)
        print(f"\nВидалено тимчасовий файл: {test_file}")
    except:
        pass
    
    print("\n=== Тестування завершено ===")

if __name__ == '__main__':
    test_partial_scoring_system()